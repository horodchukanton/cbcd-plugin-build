# cbcd-plugin-build

Plugin used in gradle projects of the specification tests in CloudBees CD plugins.

## Features:
 - Adds 'io.qameta.allure plugin' to the project, and configures it for the Spock framework
 - Applies 'groovy' plugin to the project
 - Adds system variables for the 'test' task:
    - variables from the *specs/environments/{envName}/systemtest.env* are added and logged
    - variables from the *specs/environments/{envName}/remote-secrets.env* are added and masked in log
 - Sets up some test verbosity properties
 - Sends JSON files generated by Allure to an internal reports server instance
 
## Configuration:

Plugin adds two separate tasks:

### sendAllureReports
Finalizes the 'test' task.

Usage:
```
sendAllureReports {
  serverUrl 'http://reports-server:5050/allure-docker-service'
  projectName '<plugin-name>'
}
``` 

### configureTests
Before test task starts, environment variables will be set up for the task. 

Usage:
```
configureTests {
  environmentName = findProperty('envName') ?: 'default'
  readSecrets = false
  readEnvironmentVariables = false
}
``` 

Properties that are set on the task are equal to manually specifying:
```
test {
...
  testLogging {
      showStandardStreams = true
      events 'passed', 'skipped', 'failed'
  }
  outputs.upToDateWhen { false }
  systemProperties['EC_SPECS_CLI'] = true
...
}
```